<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å–º–µ—Ç—ã –ì–µ–Ω–ø–æ–¥—Ä—è–¥—á–∏–∫–∞ (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º)</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            background: linear-gradient(145deg, #f0f4f8 0%, #e6ecf3 100%);
            margin: 0;
            padding: 24px;
            display: flex;
            justify-content: center;
        }
        .container {
            max-width: 1300px;
            width: 100%;
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 40px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            padding: 32px;
            border: 1px solid rgba(255,255,255,0.5);
        }
        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 24px;
            color: #0b1e33;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h1:before {
            content: 'üèóÔ∏è';
            font-size: 32px;
        }
        h2 {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 16px 0;
            color: #1e3a5f;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .badge {
            background: #1e3a5f;
            color: white;
            border-radius: 30px;
            padding: 4px 14px;
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        .section {
            background: white;
            border-radius: 28px;
            padding: 24px;
            margin-bottom: 28px;
            box-shadow: 0 8px 20px -6px rgba(0,20,40,0.12);
            border: 1px solid rgba(255,255,255,0.7);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        th {
            background: #eef2f6;
            color: #1e3a5f;
            font-weight: 600;
            padding: 14px 12px;
            text-align: left;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            background: white;
        }
        input, select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #cbd5e1;
            border-radius: 16px;
            font-size: 14px;
            background: #f9fcff;
            transition: 0.15s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3b6e9c;
            box-shadow: 0 0 0 4px rgba(30,58,95,0.15);
            background: white;
        }
        .btn {
            background: #1e3a5f;
            color: white;
            border: none;
            border-radius: 40px;
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 8px 14px -8px #1e3a5f80;
            margin-right: 12px;
        }
        .btn:hover {
            background: #14324f;
            transform: translateY(-1px);
            box-shadow: 0 12px 20px -8px #1e3a5f;
        }
        .btn-outline {
            background: white;
            color: #1e3a5f;
            border: 1px solid #1e3a5f;
            box-shadow: none;
        }
        .btn-outline:hover {
            background: #eef2f6;
            transform: none;
            box-shadow: none;
        }
        .btn-danger {
            background: #b91c1c;
            box-shadow: 0 8px 14px -8px #b91c1c80;
        }
        .btn-danger:hover {
            background: #991b1b;
        }
        .row-flex {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .form-group {
            flex: 1 1 200px;
        }
        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: #4b5e77;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .result-block {
            background: #f1f5f9;
            border-radius: 20px;
            padding: 20px;
            margin-top: 15px;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #a0b8cc;
            font-size: 15px;
        }
        .result-item.total {
            font-weight: 700;
            font-size: 18px;
            border-bottom: none;
            border-top: 2px solid #1e3a5f;
            margin-top: 10px;
            padding-top: 16px;
            color: #0b1e33;
        }
        .text-right {
            text-align: right;
            font-weight: 500;
        }
        .indent {
            padding-left: 36px !important;
            background-color: #fafcfd;
        }
        .match-panel {
            background: #d9eaf5;
            border-radius: 60px;
            padding: 12px 24px;
            margin-bottom: 28px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            font-weight: 500;
            border: 1px solid #b6d2e6;
            color: #0b2a44;
        }
        .match-panel span:last-child {
            background: #1e3a5f;
            color: white;
            padding: 6px 20px;
            border-radius: 40px;
            font-size: 18px;
        }
        .footnote {
            font-size: 12px;
            color: #6f7e95;
            margin-top: 10px;
        }
        .tz-output {
            background: #0b1e33;
            color: #e2e8f0;
            border-radius: 24px;
            padding: 24px;
            margin-top: 30px;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            border: 1px solid #2d4a6b;
            display: none;
        }
        .tz-output.show {
            display: block;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
            margin: 32px 0 16px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–º–µ—Ç—ã –ì–µ–Ω–ø–æ–¥—Ä—è–¥—á–∏–∫–∞ (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö)</h1>

    <!-- –ü–∞–Ω–µ–ª—å —Ä–∞–≤–µ–Ω—Å—Ç–≤–∞ -->
    <div class="match-panel">
        <span>‚úÖ –†–∞–∑–¥–µ–ª 4 (–ª–∏–º–∏—Ç –ì–ü): <strong id="match-limit">0</strong></span>
        <span>‚úÖ –†–∞–∑–¥–µ–ª 5 (—Å–º–µ—Ç–∞ –¥–ª—è –±–∞–Ω–∫–∞): <strong id="match-bank">0</strong></span>
        <span>‚úì –ò—Ç–æ–≥–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç</span>
    </div>

    <!-- –†–∞–∑–¥–µ–ª 1: –ë—é–¥–∂–µ—Ç (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫) -->
    <div class="section">
        <h2><span class="badge">1</span> –ë—é–¥–∂–µ—Ç –ì–ª–∞–≤—ã 2 (–¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã 6.1.2.)</h2>
        <table>
            <thead>
                <tr><th>–ö–æ–¥</th><th>–°—Ç–∞—Ç—å—è –∑–∞—Ç—Ä–∞—Ç</th><th>–°—É–º–º–∞, ‚ÇΩ</th></tr>
            </thead>
            <tbody id="budget-rows"></tbody>
            <tfoot>
                <tr><td colspan="2"><strong>–ò–¢–û–ì–û –ì–ª–∞–≤–∞ 2</strong></td><td><strong id="total-budget">0</strong></td></tr>
            </tfoot>
        </table>
        <div class="footnote">* —Å—Ç–∞—Ç—å–∏ 2.6‚Äì2.9 –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è –∏–∑ –æ–±—ä—ë–º–∞ –≥–µ–Ω–ø–æ–¥—Ä—è–¥—á–∏–∫–∞</div>
    </div>

    <!-- –†–∞–∑–¥–µ–ª 2: –ü—Ä—è–º—ã–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏ -->
    <div class="section">
        <h2><span class="badge">2</span> –ü—Ä—è–º—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ã (–≤—ã—á–∏—Ç–∞—é—Ç—Å—è –∏–∑ —Å—Ç–∞—Ç–µ–π 2.1‚Äì2.5)</h2>
        <table>
            <thead>
                <tr><th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th><th>–î–æ–≥–æ–≤–æ—Ä</th><th>–°—É–º–º–∞, ‚ÇΩ</th><th>–°—Ç–∞—Ç—å—è</th><th style="width:50px"></th></tr>
            </thead>
            <tbody id="direct-rows"></tbody>
        </table>
        <button class="btn btn-outline" id="add-direct-row" style="margin-top:16px;">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä—è–º–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</button>
    </div>

    <!-- –†–∞–∑–¥–µ–ª 3: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ì–ü -->
    <div class="section">
        <h2><span class="badge">3</span> –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ–≥–æ–≤–æ—Ä–∞ –ì–ü</h2>
        <div class="row-flex">
            <div class="form-group"><label>–ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã, %</label><input type="number" id="overhead-percent" value="10.0" step="0.1"></div>
            <div class="form-group"><label>–°–º–µ—Ç–Ω–∞—è –ø—Ä–∏–±—ã–ª—å, %</label><input type="number" id="profit-percent" value="6.6" step="0.1"></div>
        </div>
    </div>

    <!-- –†–∞–∑–¥–µ–ª 4: –†–∞—Å—á—ë—Ç –ª–∏–º–∏—Ç–∞ -->
    <div class="section">
        <h2><span class="badge">4</span> –õ–∏–º–∏—Ç –¥–æ–≥–æ–≤–æ—Ä–∞ –ì–ü</h2>
        <div class="result-block">
            <div class="result-item"><span>–°—É–º–º–∞ —Å—Ç–∞—Ç–µ–π 2.1‚Äì2.5 (A):</span> <span id="sum-non-excluded">0</span></div>
            <div class="result-item"><span>–ú–∏–Ω—É—Å –ø—Ä—è–º—ã–µ –ø–æ—Å—Ç–∞–≤–∫–∏ –ø–æ —Å—Ç–∞—Ç—å—è–º 2.1‚Äì2.5 (B):</span> <span id="total-direct-limit">0</span></div>
            <div class="result-item total"><span>–õ–∏–º–∏—Ç –¥–æ–≥–æ–≤–æ—Ä–∞ –ì–ü (A ‚Äì B):</span> <span id="r4-limit">0</span></div>
            <div style="margin-top:20px; border-top:2px solid #b6c9dd; padding-top:16px;">
                <div class="result-item"><span>–ü—Ä—è–º—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã (—Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å):</span> <span id="r4-direct">0</span></div>
                <div class="result-item"><span>–ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã:</span> <span id="r4-overhead">0</span></div>
                <div class="result-item"><span>–°–º–µ—Ç–Ω–∞—è –ø—Ä–∏–±—ã–ª—å:</span> <span id="r4-profit">0</span></div>
                <div class="result-item total"><span>–ò–¢–û–ì–û –¥–æ–≥–æ–≤–æ—Ä –ì–ü (—Ä–∞–≤–µ–Ω –ª–∏–º–∏—Ç—É):</span> <span id="r4-total">0</span></div>
            </div>
        </div>
    </div>

    <!-- –†–∞–∑–¥–µ–ª 5: –°–º–µ—Ç–∞ –¥–ª—è –±–∞–Ω–∫–∞ -->
    <div class="section">
        <h2><span class="badge">5</span> –°–º–µ—Ç–∞ –ì–ü –¥–ª—è –±–∞–Ω–∫–∞ (—Å—Ç–∞—Ç—å–∏ 2.1‚Äì2.5)</h2>
        <table>
            <thead>
                <tr><th>–°—Ç–∞—Ç—å—è</th><th>–õ–∏–º–∏—Ç –ø–æ –±—é–¥–∂–µ—Ç—É, ‚ÇΩ</th><th>–ü—Ä—è–º—ã–µ –ø–æ—Å—Ç–∞–≤–∫–∏, ‚ÇΩ</th><th>–°—É–º–º–∞ –≤ —Å–º–µ—Ç–µ –ì–ü, ‚ÇΩ</th></tr>
            </thead>
            <tbody id="bank-rows"></tbody>
            <tfoot>
                <tr><td colspan="3"><strong>–ò—Ç–æ–≥–æ —Å–º–µ—Ç–∞ –ì–ü (—Ç–æ–ª—å–∫–æ –∫–æ–Ω–µ—á–Ω—ã–µ —Å—Ç–∞—Ç—å–∏)</strong></td><td><strong id="bank-total">0</strong></td></tr>
            </tfoot>
        </table>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
    <div class="button-group">
        <button class="btn" id="generate-tz">üìã –°–æ—Å—Ç–∞–≤–∏—Ç—å –¢–ó –¥–ª—è –æ—Ç–¥–µ–ª–∞ –ü–¢–û</button>
        <button class="btn btn-outline" id="print-tz">üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å –¢–ó</button>
    </div>
    <div id="tz-output" class="tz-output"></div>

</div>

<script>
    (function() {
        // -------------------------------------------------------------
        //  –ï–î–ò–ù–´–ô –ú–ê–°–°–ò–í –î–ê–ù–ù–´–•
        // -------------------------------------------------------------
        const articles = [
            { code: '2.1',   name: '–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥', excluded: false },
            { code: '2.2.1', name: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—Ç–¥–µ–ª–∫–∞ —Ä–µ–∞–ª–∏–∑—É–µ–º—ã—Ö –ø–ª–æ—â–∞–¥–µ–π', excluded: false },
            { code: '2.2.2', name: '–û–±—â–µ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã (–∫—Ä–æ–º–µ –æ—Ç–¥–µ–ª–∫–∏)', excluded: false },
            { code: '2.3',   name: '–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∏–Ω–∂–µ–Ω–µ—Ä–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã', excluded: false },
            { code: '2.4',   name: '–ù–∞—Ä—É–∂–Ω—ã–µ –∏–Ω–∂–µ–Ω–µ—Ä–Ω—ã–µ —Å–µ—Ç–∏, —Ç–µ—Ö–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ', excluded: false },
            { code: '2.5',   name: '–ë–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏ –æ–∑–µ–ª–µ–Ω–µ–Ω–∏–µ', excluded: false },
            { code: '2.6',   name: '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–ª—É–∂–±—ã –∑–∞–∫–∞–∑—á–∏–∫–∞, –æ—Ö—Ä–∞–Ω–∞', excluded: true },
            { code: '2.7',   name: '–ü—Ä–æ–µ–∫—Ç–Ω—ã–µ —Ä–∞–±–æ—Ç—ã, —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞, –∞–≤—Ç–æ—Ä—Å–∫–∏–π –Ω–∞–¥–∑–æ—Ä', excluded: true },
            { code: '2.8',   name: '–†–µ–∑–µ—Ä–≤ –Ω–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã–µ', excluded: true },
            { code: '2.9',   name: '–†–µ–∑–µ—Ä–≤ –Ω–∞ –∏–Ω—Ñ–ª—è—Ü–∏—é', excluded: true }
        ];

        // –ë—é–¥–∂–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–∏–∑ —Ñ–∞–π–ª–∞)
        const defaultBudget = {
            '2.1':   49828259.44,
            '2.2.1': 31866900.00,
            '2.2.2': 314152576.55,
            '2.3':   61448739.81,
            '2.4':   21175742.64,
            '2.5':   19810429.25,
            '2.6':   4000000.00,
            '2.7':   44830000.00,
            '2.8':   26806612.40,
            '2.9':   50903148.00
        };

        // –ü—Ä—è–º—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const defaultDirectRows = [
            { supplier: '–û–û–û "–í–µ–≥–æ–ª–æ—Å –ò–Ω–∂–µ–Ω–µ—Ä–∏–Ω–≥"', contract: '02-12 (2.1)',   amount: 27435629.72, article: '2.1' },
            { supplier: '–û–û–û "–í–µ–≥–æ–ª–æ—Å –ò–Ω–∂–µ–Ω–µ—Ä–∏–Ω–≥"', contract: '02-12 (2.2.2)', amount: 159602334.31, article: '2.2.2' },
            { supplier: '–û–û–û "–í–µ–≥–æ–ª–æ—Å –ò–Ω–∂–µ–Ω–µ—Ä–∏–Ω–≥"', contract: '02-12 (2.3)',   amount: 31413530.67, article: '2.3' },
            { supplier: '–û–û–û "–í–µ–≥–æ–ª–æ—Å –ò–Ω–∂–µ–Ω–µ—Ä–∏–Ω–≥"', contract: '02-12 (2.4)',   amount: 10857877.45, article: '2.4' },
            { supplier: '–û–û–û "–ì–∞–∑—Ç–µ—Ö—Å–µ—Ä–≤–∏—Å"',       contract: '002',           amount: 18735.80,    article: '2.4' }
        ];

        // –ü—Ä–æ—Ü–µ–Ω—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const defaultOverhead = 10.0;
        const defaultProfit = 6.6;

        // -------------------------------------------------------------
        //  –ó–ê–ì–†–£–ó–ö–ê –ò–ó LOCALSTORAGE
        // -------------------------------------------------------------
        let budget = { ...defaultBudget };
        let directRows = JSON.parse(JSON.stringify(defaultDirectRows)); // –≥–ª—É–±–æ–∫–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
        let overheadPercent = defaultOverhead;
        let profitPercent = defaultProfit;

        function loadFromStorage() {
            try {
                const savedBudget = localStorage.getItem('calc_budget');
                if (savedBudget) budget = { ...budget, ...JSON.parse(savedBudget) };

                const savedDirect = localStorage.getItem('calc_directRows');
                if (savedDirect) directRows = JSON.parse(savedDirect);

                const savedOverhead = localStorage.getItem('calc_overhead');
                if (savedOverhead) overheadPercent = parseFloat(savedOverhead);

                const savedProfit = localStorage.getItem('calc_profit');
                if (savedProfit) profitPercent = parseFloat(savedProfit);
            } catch (e) {
                console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage', e);
            }
        }

        function saveToStorage() {
            try {
                localStorage.setItem('calc_budget', JSON.stringify(budget));
                localStorage.setItem('calc_directRows', JSON.stringify(directRows));
                localStorage.setItem('calc_overhead', overheadPercent.toString());
                localStorage.setItem('calc_profit', profitPercent.toString());
            } catch (e) {}
        }

        loadFromStorage();

        // -------------------------------------------------------------
        //  –≠–õ–ï–ú–ï–ù–¢–´ –ò–ù–¢–ï–†–§–ï–ô–°–ê
        // -------------------------------------------------------------
        const tbodyBudget = document.getElementById('budget-rows');
        const tbodyDirect = document.getElementById('direct-rows');
        const tbodyBank = document.getElementById('bank-rows');
        const addBtn = document.getElementById('add-direct-row');

        const totalBudgetSpan = document.getElementById('total-budget');
        const sumNonExcludedSpan = document.getElementById('sum-non-excluded');
        const totalDirectLimitSpan = document.getElementById('total-direct-limit');
        const r4LimitSpan = document.getElementById('r4-limit');
        const r4DirectSpan = document.getElementById('r4-direct');
        const r4OverheadSpan = document.getElementById('r4-overhead');
        const r4ProfitSpan = document.getElementById('r4-profit');
        const r4TotalSpan = document.getElementById('r4-total');
        const bankTotalSpan = document.getElementById('bank-total');
        const matchLimitSpan = document.getElementById('match-limit');
        const matchBankSpan = document.getElementById('match-bank');

        const overheadInput = document.getElementById('overhead-percent');
        const profitInput = document.getElementById('profit-percent');

        const tzOutput = document.getElementById('tz-output');
        const generateBtn = document.getElementById('generate-tz');
        const printBtn = document.getElementById('print-tz');

        // –£—Å—Ç–∞–Ω–æ–≤–∏–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
        overheadInput.value = overheadPercent;
        profitInput.value = profitPercent;

        // -------------------------------------------------------------
        //  –û–¢–†–ò–°–û–í–ö–ê –¢–ê–ë–õ–ò–¶–´ –ë–Æ–î–ñ–ï–¢–ê
        // -------------------------------------------------------------
        function renderBudget() {
            tbodyBudget.innerHTML = '';
            articles.forEach(a => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${a.code}</td><td>${a.name}</td>
                    <td><input type="number" class="budget-input" data-code="${a.code}" value="${budget[a.code] || 0}" step="1" style="text-align:right"></td>`;
                tbodyBudget.appendChild(tr);
            });
            document.querySelectorAll('.budget-input').forEach(inp => {
                inp.addEventListener('input', function() {
                    budget[this.dataset.code] = parseFloat(this.value) || 0;
                    recalc();
                    saveToStorage();
                });
            });
        }

        // -------------------------------------------------------------
        //  –û–¢–†–ò–°–û–í–ö–ê –ü–†–Ø–ú–´–• –î–û–ì–û–í–û–†–û–í
        // -------------------------------------------------------------
        function renderDirect() {
            tbodyDirect.innerHTML = '';
            directRows.forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" class="direct-supplier" data-index="${idx}" value="${row.supplier}" placeholder="–ü–æ—Å—Ç–∞–≤—â–∏–∫"></td>
                    <td><input type="text" class="direct-contract" data-index="${idx}" value="${row.contract}" placeholder="‚Ññ –¥–æ–≥–æ–≤–æ—Ä–∞"></td>
                    <td><input type="number" class="direct-amount" data-index="${idx}" value="${row.amount}" step="1" style="text-align:right"></td>
                    <td>
                        <select class="direct-article" data-index="${idx}">
                            ${articles.map(a => `<option value="${a.code}" ${a.code===row.article?'selected':''}>${a.code}</option>`).join('')}
                        </select>
                    </td>
                    <td><button class="btn btn-danger" style="padding:6px 12px;" onclick="removeDirect(${idx})">‚úï</button></td>
                `;
                tbodyDirect.appendChild(tr);
            });

            document.querySelectorAll('.direct-supplier, .direct-contract, .direct-amount, .direct-article').forEach(el => {
                el.addEventListener('input', function() {
                    const idx = this.dataset.index;
                    if (this.classList.contains('direct-supplier')) directRows[idx].supplier = this.value;
                    else if (this.classList.contains('direct-contract')) directRows[idx].contract = this.value;
                    else if (this.classList.contains('direct-amount')) directRows[idx].amount = parseFloat(this.value) || 0;
                    else if (this.classList.contains('direct-article')) directRows[idx].article = this.value;
                    recalc();
                    saveToStorage();
                });
            });
        }

        window.removeDirect = (idx) => { directRows.splice(idx, 1); renderDirect(); recalc(); saveToStorage(); };

        addBtn.addEventListener('click', () => {
            directRows.push({ supplier: '', contract: '', amount: 0, article: '2.1' });
            renderDirect();
            recalc();
            saveToStorage();
        });

        // -------------------------------------------------------------
        //  –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –ß–ò–°–ï–õ
        // -------------------------------------------------------------
        function format(num) {
            return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // -------------------------------------------------------------
        //  –û–°–ù–û–í–ù–û–ô –ü–ï–†–ï–°–ß–Å–¢
        // -------------------------------------------------------------
        function recalc() {
            // ---- 1. –û–±—â–∏–π –±—é–¥–∂–µ—Ç –ì–ª–∞–≤—ã 2 ----
            let totalBudget = 0;
            articles.forEach(a => totalBudget += budget[a.code] || 0);
            totalBudgetSpan.textContent = format(totalBudget);

            // ---- 2. –°—É–º–º–∞ –ø—Ä—è–º—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –ø–æ –∫–∞–∂–¥–æ–π —Å—Ç–∞—Ç—å–µ ----
            let directByArticle = {};
            articles.forEach(a => directByArticle[a.code] = 0);
            directRows.forEach(r => { if (r.article) directByArticle[r.article] += r.amount; });

            // ---- 3. –°—É–º–º–∞ —Å—Ç–∞—Ç–µ–π 2.1‚Äì2.5 ----
            let sumNonExcluded = 0;
            articles.filter(a => !a.excluded).forEach(a => sumNonExcluded += budget[a.code] || 0);
            sumNonExcludedSpan.textContent = format(sumNonExcluded);

            // ---- 4. –°—É–º–º–∞ –ø—Ä—è–º—ã—Ö –ø–æ —Å—Ç–∞—Ç—å—è–º 2.1‚Äì2.5 ----
            let totalDirectForLimit = 0;
            articles.filter(a => !a.excluded).forEach(a => totalDirectForLimit += directByArticle[a.code] || 0);
            totalDirectLimitSpan.textContent = format(totalDirectForLimit);

            // ---- 5. –õ–∏–º–∏—Ç ----
            let limit = sumNonExcluded - totalDirectForLimit;
            limit = Math.max(limit, 0);
            r4LimitSpan.textContent = format(limit);
            r4TotalSpan.textContent = format(limit);

            // ---- 6. –†–∞–∑–±–∏–≤–∫–∞ –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º ----
            let overheadPct = parseFloat(overheadInput.value) || 0;
            let profitPct = parseFloat(profitInput.value) || 0;
            let totalPct = 1 + overheadPct/100 + profitPct/100;
            let directPart = limit / totalPct;
            r4DirectSpan.textContent = format(directPart);
            r4OverheadSpan.textContent = format(directPart * overheadPct/100);
            r4ProfitSpan.textContent = format(directPart * profitPct/100);

            // ---- 7. –°–º–µ—Ç–∞ –¥–ª—è –±–∞–Ω–∫–∞ ----
            const bankDisplay = [
                { type: 'leaf', code: '2.1', name: '–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥, –≤ —Ç.—á. —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–∫—Ä–∞–Ω–æ–≤—ã—Ö –ø—É—Ç–µ–π, –ø–µ—Ä–µ–±–∞–∑–∏—Ä–æ–≤–∫–∞, –¥–µ–º–æ–Ω—Ç–∞–∂, –≤—ã–Ω–æ—Å —Å–µ—Ç–µ–π' },
                { type: 'group', code: '2.2', name: '–û–±—â–µ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã, –≤ —Ç.—á.:', children: ['2.2.1','2.2.2'] },
                { type: 'leaf', code: '2.2.1', name: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—Ç–¥–µ–ª–∫–∞ —Ä–µ–∞–ª–∏–∑—É–µ–º—ã—Ö –ø–ª–æ—â–∞–¥–µ–π', indent: true },
                { type: 'leaf', code: '2.2.2', name: '–û–±—â–µ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã (–∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –æ—Ç–¥–µ–ª–∫–∏)', indent: true },
                { type: 'leaf', code: '2.3', name: '–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∏–Ω–∂–µ–Ω–µ—Ä–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã' },
                { type: 'leaf', code: '2.4', name: '–ù–∞—Ä—É–∂–Ω—ã–µ –∏–Ω–∂–µ–Ω–µ—Ä–Ω—ã–µ —Å–µ—Ç–∏, –≤ —Ç.—á. –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ —Ç–µ—Ö–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –ò–°' },
                { type: 'leaf', code: '2.5', name: '–ë–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏ –æ–∑–µ–ª–µ–Ω–µ–Ω–∏–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏, –æ–±—ä–µ–∫—Ç—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–≥–æ —Ö–æ–∑—è–π—Å—Ç–≤–∞' }
            ];

            let bankTotal = 0;
            let bankHtml = '';

            bankDisplay.forEach(item => {
                if (item.type === 'group') {
                    let budgetSum = 0, directSum = 0;
                    item.children.forEach(c => {
                        budgetSum += budget[c] || 0;
                        directSum += directByArticle[c] || 0;
                    });
                    let gpSum = budgetSum - directSum;
                    bankHtml += `<tr><td><strong>${item.code} ${item.name}</strong></td>
                        <td class="text-right">${format(budgetSum)}</td>
                        <td class="text-right">${format(directSum)}</td>
                        <td class="text-right">${format(gpSum)}</td></tr>`;
                } else {
                    let budgetAmt = budget[item.code] || 0;
                    let directAmt = directByArticle[item.code] || 0;
                    let gpAmt = budgetAmt - directAmt;
                    bankTotal += gpAmt;
                    let indentClass = item.indent ? 'indent' : '';
                    bankHtml += `<tr class="${indentClass}"><td>${item.code} ${item.name}</td>
                        <td class="text-right">${format(budgetAmt)}</td>
                        <td class="text-right">${format(directAmt)}</td>
                        <td class="text-right">${format(gpAmt)}</td></tr>`;
                }
            });

            tbodyBank.innerHTML = bankHtml;
            bankTotalSpan.textContent = format(bankTotal);

            // ---- 8. –ö–æ–Ω—Ç—Ä–æ–ª—å ----
            matchLimitSpan.textContent = format(limit);
            matchBankSpan.textContent = format(bankTotal);
        }

        // -------------------------------------------------------------
        //  –ì–ï–ù–ï–†–ê–¶–ò–Ø –¢–ó
        // -------------------------------------------------------------
        function getTZText() {
            const overheadPct = parseFloat(overheadInput.value) || 0;
            const profitPct = parseFloat(profitInput.value) || 0;

            let directText = '';
            directRows.forEach((r, i) => {
                directText += `${i+1}. ${r.supplier || '‚Äî'}, –¥–æ–≥–æ–≤–æ—Ä ${r.contract || '‚Äî'}, —Å—É–º–º–∞ ${format(r.amount)} ‚ÇΩ (—Å—Ç–∞—Ç—å—è ${r.article})\n`;
            });

            // —Å—É–º–º–∞ –ø—Ä—è–º—ã—Ö –ø–æ –Ω–µ–∏—Å–∫–ª—é—á–∞–µ–º—ã–º
            let directSumNonExcluded = 0;
            directRows.forEach(r => {
                const art = articles.find(a => a.code === r.article);
                if (art && !art.excluded) directSumNonExcluded += r.amount;
            });

            const sumNonExcluded = articles.filter(a => !a.excluded).reduce((s,a)=>s+(budget[a.code]||0),0);
            const limit = parseFloat(r4LimitSpan.textContent.replace(/,/g,'')) || 0;
            const directPart = parseFloat(r4DirectSpan.textContent.replace(/,/g,'')) || 0;
            const overhead = parseFloat(r4OverheadSpan.textContent.replace(/,/g,'')) || 0;
            const profit = parseFloat(r4ProfitSpan.textContent.replace(/,/g,'')) || 0;

            let rows = '';
            articles.filter(a => !a.excluded).forEach(a => {
                let direct = directRows.filter(r => r.article === a.code).reduce((s,r)=>s+r.amount,0);
                rows += `${a.code} ${a.name}: ${format(budget[a.code])} - ${format(direct)} = ${format(budget[a.code]-direct)} ‚ÇΩ\n`;
            });

            return `üìã –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ó–ê–î–ê–ù–ò–ï –î–õ–Ø –û–¢–î–ï–õ–ê –ü–¢–û
=====================================
–î–∞—Ç–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è: ${new Date().toLocaleDateString('ru-RU')}

1Ô∏è‚É£ –ò–°–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï (–ì–ª–∞–≤–∞ 2, —Ñ–æ—Ä–º–∞ 6.1.2.)
---------------------------------
${articles.filter(a => !a.excluded).map(a => `${a.code} ${a.name}: ${format(budget[a.code])} ‚ÇΩ`).join('\n')}
–ò–¢–û–ì–û —Å—Ç–∞—Ç—å–∏ 2.1‚Äì2.5: ${format(sumNonExcluded)} ‚ÇΩ

2Ô∏è‚É£ –ü–†–Ø–ú–´–ï –î–û–ì–û–í–û–†–´ (–≤—ã—á–∏—Ç–∞—é—Ç—Å—è)
---------------------------------
${directText || '‚Äî –Ω–µ—Ç –ø—Ä—è–º—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤ ‚Äî'}

3Ô∏è‚É£ –†–ê–°–ß–Å–¢–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´
---------------------------------
–ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã: ${overheadPct}%
–°–º–µ—Ç–Ω–∞—è –ø—Ä–∏–±—ã–ª—å: ${profitPct}%

4Ô∏è‚É£ –õ–ò–ú–ò–¢ –î–û–ì–û–í–û–†–ê –ì–ï–ù–ü–û–î–†–Ø–î–ß–ò–ö–ê
---------------------------------
–°—É–º–º–∞ —Å—Ç–∞—Ç–µ–π 2.1‚Äì2.5:       ${format(sumNonExcluded)} ‚ÇΩ
–ü—Ä—è–º—ã–µ –ø–æ—Å—Ç–∞–≤–∫–∏ (2.1‚Äì2.5): - ${format(directSumNonExcluded)} ‚ÇΩ
–õ–ò–ú–ò–¢ (–±–∞–∑–∞): = ${format(limit)} ‚ÇΩ

–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞:
  ‚Ä¢ –ü—Ä—è–º—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã (—Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å): ${format(directPart)} ‚ÇΩ
  ‚Ä¢ –ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã (${overheadPct}%): ${format(overhead)} ‚ÇΩ
  ‚Ä¢ –°–º–µ—Ç–Ω–∞—è –ø—Ä–∏–±—ã–ª—å (${profitPct}%): ${format(profit)} ‚ÇΩ
–ò–¢–û–ì–û –î–û–ì–û–í–û–†: ${format(limit)} ‚ÇΩ

5Ô∏è‚É£ –°–ú–ï–¢–ê –î–õ–Ø –ë–ê–ù–ö–ê (–ø–æ —Å—Ç–∞—Ç—å—è–º)
---------------------------------
${rows}
‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞: ${format(limit)} ‚ÇΩ

üëâ –ü—Ä–æ—à—É —Å–æ—Å—Ç–∞–≤–∏—Ç—å —Å–º–µ—Ç—É –≥–µ–Ω–ø–æ–¥—Ä—è–¥—á–∏–∫–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º.
`;
        }

        function generateTZ() {
            tzOutput.textContent = getTZText();
            tzOutput.classList.add('show');
        }

        function printTZ() {
            const tzText = getTZText();
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head><title>–¢–ó –¥–ª—è –ü–¢–û</title>
                <style>
                    body { font-family: 'Courier New', monospace; white-space: pre-wrap; padding: 2cm; }
                </style>
                </head>
                <body>${tzText.replace(/\n/g, '<br>')}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        generateBtn.addEventListener('click', generateTZ);
        printBtn.addEventListener('click', printTZ);

        // -------------------------------------------------------------
        //  –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ü–†–û–¶–ï–ù–¢–û–í
        // -------------------------------------------------------------
        overheadInput.addEventListener('input', () => {
            recalc();
            saveToStorage();
        });
        profitInput.addEventListener('input', () => {
            recalc();
            saveToStorage();
        });

        // -------------------------------------------------------------
        //  –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // -------------------------------------------------------------
        renderBudget();
        renderDirect();
        recalc();
    })();
</script>
</body>
</html>
